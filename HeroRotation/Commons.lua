local a,b=...local c=HeroLib;local d=b.Cast;local e,f=HeroCache,c.Utils;local g=c.Unit;local h=g.Player;local j=g.Target;local k=c.Spell;local l=c.Item;local pairs=pairs;local m=string.gsub;local UnitInParty=UnitInParty;local UnitInRaid=UnitInRaid;b.Commons={}local n={}b.Commons.Everyone=n;local o=b.GUISettings.General;local p=b.GUISettings.Abilities;function n.TargetIsValid()return j:Exists()and h:CanAttack(j)and not j:IsDeadOrGhost()end;function n.UnitIsCycleValid(g,q,r)return not g:IsFacingBlacklisted()and not g:IsUserCycleBlacklisted()and(not q or g:FilteredTimeToDie(">",q,r))end;function n.CanDoTUnit(g,s)return g:Health()>=s or g:IsDummy()end;local t={Buff={k(191941),k(204151),k(239932)},Debuff={348074,358988,347607,351180,353929},Cast={197810,197418,198079,214003,235751,193668,227493,228852,193211,200732,241635,241636,236494,239932,254919,244899,245458,248499,258039,346985,350828,350202,350475,351066,350422,352538,350732,348071},Channel={}}local u={Buff={},Debuff={},Cast={350732,355352,353603},Channel={}}function n.Interrupt(k,v,w)if o.InterruptEnabled and j:IsInterruptible()then if k:IsCastable(true)and j:IsSpellInRange(k)then if d(k,v)then shouldcast=k:ID()return"Cast "..k:Name().." (Interrupt)"end elseif o.InterruptWithStun and j:CanBeStunned()then if w then for i=1,#w do if w[i][1]:IsCastable()and j:IsSpellInRange(w[i][1])and w[i][3]()then if d(w[i][1])then shouldcast=w[i][1]:ID()return w[i][2]end end end end end end end;function n.ActiveMitigationNeeded()if not h:IsTanking(j)then return false end;if t.Cast[j:CastSpellID()]then return true end;for _,x in pairs(t.Buff)do if j:BuffUp(x,true)then return true end end;for _,y in pairs(t.Debuff)do local _,_,z,_,_,_,_,_,_,A,_,_,_,_,_,_=UnitDebuff("player",y)if A~=nil then if y==A then return true end end end;return false end;function n.BigActiveMitigationNeeded()if not h:IsTanking(j)then return false end;if u.Cast[j:CastSpellID()]then return true end;for _,x in pairs(u.Buff)do if j:BuffUp(x,true)then return true end end;for _,y in pairs(u.Debuff)do local _,_,z,_,_,_,_,_,_,A,_,_,_,_,_,_=UnitDebuff("player",i)if A~=nil then if y==A then return true end end end;return false end;do local B={Debuff={k(243961)}}function h:HealingAbsorbed()for _,y in pairs(B.Debuff)do if h:DebuffUp(y,true)then return true end end;return false end end;function n.IsSoloMode()return o.SoloMode and not h:IsInRaidArea()and not h:IsInDungeonArea()end;function n.CastCycle(C,D,E,F,G,H)if E(j)then return b.Cast(C,G,H,F)end;if b.AoEON()then local I=j:GUID()for _,J in pairs(D)do if J:GUID()~=I and not J:IsFacingBlacklisted()and not J:IsUserCycleBlacklisted()and E(J)then b.CastLeftNameplate(J,C)break end end end end;function n.CastTargetIf(C,D,K,L,E,F,G,H)local M=not E or E and E(j)if not b.AoEON()and M then return b.Cast(C,G,H,F)end;if b.AoEON()then local N,O=nil,nil;for _,J in pairs(D)do if not J:IsFacingBlacklisted()and not J:IsUserCycleBlacklisted()and(J:AffectingCombat()or J:IsDummy())and(not O or f.CompareThis(K,L(J),O))then N,O=J,L(J)end end;if N then if M and(N:GUID()==j:GUID()or O==L(j))then return b.Cast(C,G,H,F)elseif E and E(N)or not E then b.CastLeftNameplate(N,C)end end end end;function n.GroupBuffMissing(P)local Q=40;if P:Name()=="Battle Shout"then Q=100 end;local R;if UnitInRaid("player")then R=g.Raid elseif UnitInParty("player")then R=g.Party else return false end;for _,S in pairs(R)do if S:Exists()and S:IsInRange(Q)and S:BuffDown(P,true)then return true end end;return false end;function n.GetCurrentEmpowerData(T)local U=0;local V={}_,_,_,StartTimeMS,EndTimeMS,_,_,_,_,StageTotal=UnitChannelInfo("player")if StageTotal and StageTotal>0 then local W=0;for i=1,StageTotal do V[i]={Start=W,Finish=W+GetUnitEmpowerStageDuration("player",i-1)/1000}b.Print(" Start"..i..": "..V[i].Start)b.Print("Finish"..i..": "..V[i].Finish)W=V[i].Finish;if StartTimeMS/1000+W<=GetTime()then U=i end end end;if T then return U else return V end end;function n.PotionSelected()local X={"Warrior","Paladin","Hunter","Rogue","Priest","DeathKnight","Shaman","Mage","Warlock","Monk","Druid","DemonHunter","Evoker"}local Y=e.Persistent.Player.Class[3]local Z=X[Y]local a0={[250]="Blood",[251]="Frost",[252]="Unholy",[577]="Havoc",[581]="Vengeance",[102]="Balance",[103]="Feral",[104]="Guardian",[105]="Restoration",[1467]="Devastation",[1468]="Preservation",[1473]="Augmentation",[253]="BeastMastery",[254]="Marksmanship",[255]="Survival",[62]="Arcane",[63]="Fire",[64]="Frost",[268]="Brewmaster",[269]="Windwalker",[270]="Mistweaver",[65]="Holy",[66]="Protection",[70]="Retribution",[256]="Discipline",[257]="Holy",[258]="Shadow",[259]="Assassination",[260]="Outlaw",[261]="Subtlety",[262]="Elemental",[263]="Enhancement",[264]="Restoration",[265]="Affliction",[266]="Demonology",[267]="Destruction",[71]="Arms",[72]="Fury",[73]="Protection"}local a1=e.Persistent.Player.Spec[1]local a2=a0[a1]local a3=b.GUISettings.APL[Z][a2].PotionType.Selected;local a4={191914,191913,191912,191907,191906,191905,191383,191382,191381,191389,191388,191387}local a5={191365,191364,191363}local a6={191368,191367,191366}local a7={191401,191400,191399}if a3=="Power"then for _,a8 in ipairs(a4)do if l(a8):IsUsable()then return l(a8)end end elseif a3=="Frozen Focus"then for _,a8 in ipairs(a5)do if l(a8):IsUsable()then return l(a8)end end elseif a3=="Chilled Clarity"then for _,a8 in ipairs(a6)do if l(a8):IsUsable()then return l(a8)end end elseif a3=="Shocking Disclosure"then for _,a8 in ipairs(a7)do if l(a8):IsUsable()then return l(a8)end end else return nil end end