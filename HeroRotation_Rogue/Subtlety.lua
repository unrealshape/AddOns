local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=d.Spell;local j=d.Item;local k=d.Utils.BoolToInt;local l=HeroRotation;local m=l.AoEON;local n=l.CDsON;local o=l.Cast;local p=l.CastPooling;local q=l.CastQueue;local r=l.CastQueuePooling;local s=HeroRotationCharDB.Toggles[4]local t=HeroRotationCharDB.Toggles[5]local u=HeroRotationCharDB.Toggles[12]local v={not HeroRotationCharDB.Toggles[15],HeroRotationCharDB.Toggles[20],HeroRotationCharDB.Toggles[21],HeroRotationCharDB.Toggles[22],HeroRotationCharDB.Toggles[23],HeroRotationCharDB.Toggles[24],HeroRotationCharDB.Toggles[25],HeroRotationCharDB.Toggles[26],HeroRotationCharDB.Toggles[27],HeroRotationCharDB.Toggles[28],HeroRotationCharDB.Toggles[29],HeroRotationCharDB.Toggles[30],HeroRotationCharDB.Toggles[54],HeroRotationCharDB.Toggles[172],HeroRotationCharDB.Toggles[173]}local w={General=l.GUISettings.General,Commons=l.GUISettings.APL.Rogue.Commons,Subtlety=l.GUISettings.APL.Rogue.Subtlety}local x={324736,228318,178658,333227,334800,334967,324737,326450,334470,320703,320012,324085,333241,331510,344739,368477,368396,355057,356133,342139,353706,355782,327155,359668,321220,158337,382555}local y=nil;local z=nil;local A=0;local B=0;local pairs=pairs;local C=table.insert;local D=math.min;local E=math.max;local F=math.abs;local G=l.Commons.Everyone;local H=l.Commons.Rogue;local I=i.Rogue.Subtlety;local J=j.Rogue.Subtlety;local K={J.Mirror:ID(),J.WitherbarksBranch:ID(),J.AshesoftheEmbersoul:ID()}local L,M,N,O;local P,Q,R,S;local T;local U,V,W;local X,Y;local Z,_,a0,a1;local a2;I.Eviscerate:RegisterDamageFormula(function()return g:AttackPowerDamageMod()*Z*0.176*1.21*(I.Nightstalker:IsAvailable()and g:StealthUp(true,false)and 1.08 or 1)*(I.DeeperStratagem:IsAvailable()and 1.05 or 1)*(I.DarkShadow:IsAvailable()and g:BuffUp(I.ShadowDanceBuff)and 1.3 or 1)*(g:BuffUp(I.SymbolsofDeath)and 1.1 or 1)*(g:BuffUp(I.FinalityEviscerateBuff)and 1.3 or 1)*(1+g:MasteryPct()/100)*(1+g:VersatilityDmgPct()/100)*(h:DebuffUp(I.FindWeaknessDebuff)and 1.5 or 1)end)local w={General=l.GUISettings.General,Commons=l.GUISettings.APL.Rogue.Commons,Commons2=l.GUISettings.APL.Rogue.Commons2,Subtlety=l.GUISettings.APL.Rogue.Subtlety}local function a3(a4,a5)if not U then U=a4;V=a5 or 0 end end;local function a6(a4)if not W then W=a4 end end;local function a7()if w.Subtlety.BurnShadowDance=="On Bosses not in Dungeons"and g:IsInDungeonArea()then return false elseif w.Subtlety.BurnShadowDance~="Always"and not h:IsInBossList()then return false else return true end end;local function a8()if R<2 then return false elseif w.Commons.UsePriorityRotation=="Always"then return true elseif w.Commons.UsePriorityRotation=="On Bosses"and h:IsInBossList()then return true elseif w.Commons.UsePriorityRotation=="Auto"then if g:InstanceDifficulty()==16 and h:NPCID()==138967 then return true elseif h:NPCID()==166969 or h:NPCID()==166971 or h:NPCID()==166970 then return true elseif h:NPCID()==183463 or h:NPCID()==183671 then return true end end;return false end;local a9=g:GetEquipment()local aa=a9[13]and j(a9[13])or j(0)local ab=a9[14]and j(a9[14])or j(0)local ac=GetInventoryItemID("player",13)local ad=GetInventoryItemID("player",14)local K={}d:RegisterForEvent(function()a9=g:GetEquipment()aa=a9[13]and j(a9[13])or j(0)ab=a9[14]and j(a9[14])or j(0)end,"PLAYER_EQUIPMENT_CHANGED")local T;local ae=H.ReturnSpell()local af=H.ReturnSpellMO()local ag,ah;local ai=11111;local aj=11111;local ak,_,a0;local al=false;local function am(an,ao,ap,aq)local ar,as=nil,ap;local at=h:GUID()for au,av in pairs(aq)do if av:GUID()~=at and G.UnitIsCycleValid(av,as,-av:DebuffRemains(an))and ao(av)then ar,as=av,av:TimeToDie()end end;if ar then l.CastLeftNameplate(ar,an)if ar:GUID()==f("mouseover"):GUID()and w.Subtlety.TargetSwap=="Mouseover"then if an==I.Rupture then af=11943 elseif an==I.SerratedBoneSpike then af=1328547 end elseif w.Subtlety.TargetSwap=="AutoSwap"and ar:GUID()~=h:GUID()and not u then af=9999 end elseif false then ar,as=nil,ap;for au,av in pairs(Q)do if av:GUID()~=at and G.UnitIsCycleValid(av,as,-av:DebuffRemains(an))and ao(av)then ar,as=av,av:TimeToDie()end end;if ar then l.CastLeftNameplate(ar,an)if ar:GUID()==f("mouseover"):GUID()and w.Subtlety.TargetSwap=="Mouseover"then if an==I.Rupture then af=11943 elseif an==I.SerratedBoneSpike then af=1328547 end elseif w.Subtlety.TargetSwap=="AutoSwap"and ar:GUID()~=h:GUID()and not u then af=9999 end end end end;local function aw(ax)if ax then return 1 else return 0 end end;local function ay()return 20+I.Vigor:TalentRank()*25+aw(I.ThistleTea:IsAvailable())*20+aw(I.Shadowcraft:IsAvailable())*20 end;local function az()return I.ShadowDance:ChargesFractional()>=0.75+k(I.ShadowDanceTalent:IsAvailable())end;local function aA()return a0>=3 end;local function aB()return g:BuffUp(I.SliceandDice)or R>=H.CPMaxSpend()end;local function aC()return I.Premeditation:IsAvailable()and R<5 end;local function aD(aE)return g:BuffUp(I.ThistleTea)and R==1 or aE and(R==1 or h:DebuffUp(I.Rupture)and R>=2)end;local function aF()return(not g:BuffUp(I.TheRotten)or not g:HasTier(30,2))and(not I.ColdBlood:IsAvailable()or I.ColdBlood:CooldownRemains()<4 or I.ColdBlood:CooldownRemains()>10)end;local function aG(i)return g:BuffUp(I.ShadowDanceBuff)and i:TimeSinceLastCast()<I.ShadowDance:TimeSinceLastCast()end;local function aH()return(aG(I.Shadowstrike)or aG(I.ShurikenStorm))and(aG(I.Eviscerate)or aG(I.BlackPowder)or aG(I.Rupture))or not I.DanseMacabre:IsAvailable()end;local function aI()return not J.WitherbarksBranch:IsEquipped()and not J.AshesoftheEmbersoul:IsEquipped()or not J.WitherbarksBranch:IsEquipped()and J.WitherbarksBranch:CooldownRemains()<=8 or J.WitherbarksBranch:IsEquipped()and J.WitherbarksBranch:CooldownRemains()<=8 or J.BandolierOfTwistedBlades:IsEquipped()or I.InvigoratingShadowdust:IsAvailable()end;local function aJ(aK,aL)local aE=g:BuffUp(I.ShadowDanceBuff)local aM=g:BuffRemains(I.ShadowDanceBuff)local aN=g:BuffRemains(I.SymbolsofDeath)local aO=_;local aP=I.ColdBlood:CooldownRemains()local aQ=I.SymbolsofDeath:CooldownRemains()local aR=g:BuffUp(I.PremeditationBuff)or aL and I.Premeditation:IsAvailable()if aL and aL:ID()==I.ShadowDance:ID()then aE=true;aM=8+I.ImprovedShadowDance:TalentRank()if I.TheFirstDance:IsAvailable()then aO=D(g:ComboPointsMax(),_+4)end;if g:HasTier(30,2)then aN=E(aN,6)end end;if aL and aL:ID()==I.Vanish:ID()then aP=D(0,I.ColdBlood:CooldownRemains()-15*I.InvigoratingShadowdust:TalentRank())aQ=D(0,I.SymbolsofDeath:CooldownRemains()-15*I.InvigoratingShadowdust:TalentRank())end;if I.Rupture:IsCastable()and I.Rupture:IsReady()then if h:DebuffDown(I.Rupture)and h:TimeToDie()>6 then if aK then return I.Rupture else if I.Rupture:IsReady()and l.Cast(I.Rupture)then ae=1943;return"Cast Rupture"end;a6(I.Rupture)end end end;if not g:StealthUp(true,true)and not aC()and R<6 and not aE and d.BossFilteredFightRemains(">",g:BuffRemains(I.SliceandDice))and g:BuffRemains(I.SliceandDice)<(1+g:ComboPoints())*1.8 then if aK then return I.SliceandDice else if I.SliceandDice:IsReady()and l.Cast(I.SliceandDice)then ae=5171;return"Cast Slice and Dice Premed"end;a6(I.SliceandDice)end end;if(not aD(aE)or a2)and h:TimeToDie()>6 and h:DebuffRefreshable(I.Rupture,X)then if aK then return I.Rupture else if I.Rupture:IsReady()and l.Cast(I.Rupture)then ae=1943;return"Cast Rupture"end;a6(I.Rupture)end end;if g:BuffUp(I.FinalityRuptureBuff)and aE and R<=4 and not aG(I.Rupture)then if aK then return I.Rupture else if I.Rupture:IsReady()and l.Cast(I.Rupture)then ae=1943;return"Cast Rupture Finality"end;a6(I.Rupture)end end;if I.ColdBlood:IsReady()and aH(aE,aR)and I.SecretTechnique:IsReady()then if true then l.Cast(I.ColdBlood)else if aK then return I.ColdBlood end;if l.Cast(I.ColdBlood)then ae=382245;return"Cast Cold Blood (SecTec)"end end end;if I.SecretTechnique:IsReady()then if aH(aE,aR)and(not I.ColdBlood:IsAvailable()or I.ColdBlood:IsReady()or g:BuffUp(I.ColdBlood)or aP>aM-2 or not I.ImprovedShadowDance:IsAvailable())then if aK then return I.SecretTechnique end;if l.Cast(I.SecretTechnique)then ae=280719;return"Cast Secret Technique"end end end;if not aD(aE)and I.Rupture:IsCastable()then if not aK and l.AoEON()and not a2 and R>=2 then local function aS(aT)return G.CanDoTUnit(aT,Y)and aT:DebuffRefreshable(I.Rupture,X)end;am(I.Rupture,aS,2*aO,S)end;if N and h:DebuffRemains(I.Rupture)<aQ+10 and aQ<=5 and H.CanDoTUnit(h,Y)and h:FilteredTimeToDie(">",5+aQ,-h:DebuffRemains(I.Rupture))then if aK then return I.Rupture else if I.Rupture:IsReady()and l.Cast(I.Rupture)then ae=1943;return"Cast Rupture 2"end;a6(I.Rupture)end end end;if I.BlackPowder:IsCastable()and(not a2 and R>=3)then if aK then return I.BlackPowder else if I.BlackPowder:IsReady()and l.Cast(I.BlackPowder)then ae=319175;return"Cast Black Powder"end;a6(I.BlackPowder)end end;if I.Eviscerate:IsCastable()and N then if aK then return I.Eviscerate else if I.Eviscerate:IsReady()and l.Cast(I.Eviscerate)then ae=196819;return"Cast Eviscerate"end;a6(I.Eviscerate)end end;return false end;local function aU(aK,aL)local aE=g:BuffUp(I.ShadowDanceBuff)local aM=g:BuffRemains(I.ShadowDanceBuff)local aV=g:BuffUp(I.TheRottenBuff)local aW,aX=_,a0;local aR=g:BuffUp(I.PremeditationBuff)or aL and I.Premeditation:IsAvailable()local aY=g:BuffUp(H.StealthSpell())or aL and aL:ID()==H.StealthSpell():ID()local aZ=g:BuffUp(H.VanishBuffSpell())or aL and aL:ID()==I.Vanish:ID()if aL and aL:ID()==I.ShadowDance:ID()then aE=true;aM=8+I.ImprovedShadowDance:TalentRank()if I.TheRotten:IsAvailable()and g:HasTier(30,2)then aV=true end;if I.TheFirstDance:IsAvailable()then aW=D(g:ComboPointsMax(),_+4)aX=g:ComboPointsMax()-aW end end;local a_=H.EffectiveComboPoints(aW)local b0=I.Shadowstrike:IsCastable()or aY or aZ or aE or g:BuffUp(I.SepsisBuff)if aY or aZ then b0=b0 and h:IsInRange(25)else b0=b0 and N end;if b0 and aY and(R<4 or a2)then if aK then return I.Shadowstrike else if l.Cast(I.Shadowstrike)then ae=185438;return"Cast Shadowstrike (Stealth)"end end end;if a_>=H.CPMaxSpend()then return aJ(aK,aL)end;if g:BuffUp(I.ShurikenTornado)and aX<=2 then return aJ(aK,aL)end;if a0<=1+aw(I.DeeperStratagem:IsAvailable()or I.SecretStratagem:IsAvailable())then return aJ(aK,aL)end;if I.Backstab:IsCastable()and not aR and aM>=3 and g:BuffUp(I.ShadowBlades)and not aG(I.Backstab)and I.DanseMacabre:IsAvailable()and R<=3 and not aV then if aK then if aL then return I.Backstab else return{I.Backstab,I.Stealth}end else if q(I.Backstab,I.Stealth)then ae=600;return"Cast Backstab (Stealth)"end end end;if I.Gloomblade:IsAvailable()then if not aR and aM>=3 and g:BuffUp(I.ShadowBlades)and not aG(I.Gloomblade)and I.DanseMacabre:IsAvailable()and R<=4 then if aK then if aL then return I.Gloomblade else return{I.Gloomblade,I.Stealth}end else if q(I.Gloomblade,I.Stealth)then ae=700;return"Cast Gloomblade (Danse)"end end end end;if not aG(I.Shadowstrike)and g:BuffUp(I.ShadowBlades)then if aK then return I.Shadowstrike else if l.Cast(I.Shadowstrike)then ae=185438;return"Cast Shadowstrike (Danse)"end end end;if not aR and R>=4 then if aK then return I.ShurikenStorm else if l.Cast(I.ShurikenStorm)then ae=277925;return"Cast Shuriken Storm"end end end;if b0 then if aK then return I.Shadowstrike else if l.Cast(I.Shadowstrike)then ae=185438;return"Cast Shadowstrike"end end end;return false end;local function b1(aL,a5)local b2=aU(true,aL)if aL:ID()==I.Vanish:ID()and VanishReady and not v[3]and w.Commons.VanishOffensive then if l.Cast(I.Vanish,nil)then ae=1856;return"Cast Vanish"end;return false elseif aL:ID()==I.Shadowmeld:ID()then if l.Cast(I.Shadowmeld,nil)then ae=1000;return"Cast Shadowmeld"end;return false elseif aL:ID()==I.ShadowDance:ID()and SDReady and not v[14]then if l.Cast(I.ShadowDance,nil)then ae=185313;return"Cast Shadow Dance"end;return false end;local b3={aL,b2}if a5 and g:EnergyPredicted()<a5 then a3(b3,a5)return false end;T=l.CastQueue(unpack(b3),nil)if T then ae=unpack(b3):ID()return"| "..b3[2]:Name()end;return false end;local function b4()if l.CDsON()and I.ColdBlood:IsReady()and not I.SecretTechnique:IsAvailable()and _>=5 then if l.Cast(I.ColdBlood,nil)then ae=382245;return"Cast Cold Blood"end end;if l.CDsON()and I.Sepsis:IsAvailable()and I.Sepsis:IsReady()then if aB()and h:FilteredTimeToDie(">=",16)and(g:BuffUp(I.PerforatedVeins)or not I.PerforatedVeins:IsAvailable())then if l.Cast(I.Sepsis,nil,nil)then ae=328305;return"Cast Sepsis"end end end;if l.CDsON()and I.Flagellation:IsAvailable()and I.Flagellation:IsReady()then if aB()and Z>=5 and h:TimeToDie()>10 and(aI()and I.ShadowBlades:CooldownRemains()<=3 or d.BossFilteredFightRemains("<=",28)or I.ShadowBlades:CooldownRemains()>=14 and I.InvigoratingShadowdust:IsAvailable()and I.ShadowDance:IsAvailable())and(not I.InvigoratingShadowdust:IsAvailable()or I.Sepsis:IsAvailable()or not I.ShadowDance:IsAvailable()or I.InvigoratingShadowdust:TalentRank()==2 and R>=2 or I.SymbolsofDeath:CooldownRemains()<=3 or g:BuffRemains(I.SymbolsofDeath)>3)then if l.Cast(I.Flagellation,nil,nil)then ae=323654;return"Cast Flagellation"end end end;if SoDReady and not v[15]and I.SymbolsofDeath:IsReady()then if aB()and(not g:BuffUp(I.TheRotten)or not g:HasTier(30,2))and g:BuffRemains(I.SymbolsofDeath)<=3 and(not I.Flagellation:IsAvailable()or I.Flagellation:CooldownRemains()>10 or g:BuffRemains(I.ShadowDance)>=2 and I.InvigoratingShadowdust:IsAvailable()or I.Flagellation:IsReady()and Z>=5 and not I.InvigoratingShadowdust:IsAvailable())then if l.Cast(I.SymbolsofDeath,nil)then ae=212283;return"Cast Symbols of Death"end end end;if SBReady and I.ShadowBlades:IsReady()then if aB()and(Z<=1 or g:HasTier(31,4))and(g:BuffUp(I.Flagellation)or g:BuffUp(I.FlagellationPersistBuff)or not I.Flagellation:IsAvailable())then if l.Cast(I.ShadowBlades,nil)then ae=121471;return"Cast Shadow Blades"end end end;if l.CDsON()and I.EchoingReprimand:IsCastable()and I.EchoingReprimand:IsAvailable()then if aB()and a0>=3 then if l.Cast(I.EchoingReprimand,nil,nil)then ae=323547;return"Cast Echoing Reprimand"end end end;if STReady and not v[11]and I.ShurikenTornado:IsAvailable()and I.ShurikenTornado:IsReady()then if aB()and g:BuffUp(I.SymbolsofDeath)and Z<=2 and not g:BuffUp(I.Premeditation)and(not I.Flagellation:IsAvailable()or I.Flagellation:CooldownRemains()>20)and R>=3 then if l.Cast(I.ShurikenTornado,nil)then ae=277925;return"Cast Shuriken Tornado"end end end;if STReady and not v[11]and I.ShurikenTornado:IsAvailable()and I.ShurikenTornado:IsReady()then if aB()and not g:BuffUp(I.ShadowDance)and not g:BuffUp(I.Flagellation)and not g:BuffUp(I.FlagellationPersistBuff)and not g:BuffUp(I.ShadowBlades)and R<=2 then if l.Cast(I.ShurikenTornado,nil)then ae=277925;return"Cast Shuriken Tornado"end end end;if SDReady and not v[14]and I.ShadowDance:IsAvailable()and a7()and I.ShadowDance:IsReady()then if not g:BuffUp(I.ShadowDance)and d.BossFilteredFightRemains("<=",8+3*aw(I.Subterfuge:IsAvailable()))then if l.Cast(I.ShadowDance,nil)then ae=185313;return"Cast Shadow Dance"end end end;if l.CDsON()and I.GoremawsBite:IsAvailable()and I.GoremawsBite:IsReady()then if aB()and a0>=3 and(not I.ShadowDance:IsReady()or I.ShadowDance:IsAvailable()and g:BuffUp(I.ShadowDance)and not I.InvigoratingShadowdust:IsAvailable()or R<4 and not I.InvigoratingShadowdust:IsAvailable()or I.TheRotten:IsAvailable())then if l.Cast(I.GoremawsBite)then ae=426591;return"Cast Goremaw's Bite"end end end;if I.ThistleTea:IsReady()then if(I.SymbolsofDeath:CooldownRemains()>=3 or g:BuffUp(I.SymbolsofDeath))and not g:BuffUp(I.ThistleTea)and(g:EnergyDeficitPredicted()>=100 and(a0>=2 or R>=3)or I.ThistleTea:ChargesFractional()>=2.75-0.15*I.InvigoratingShadowdust:TalentRank()and I.Vanish:IsReady()and g:BuffUp(I.ShadowDance)and h:DebuffUp(I.Rupture)and R<3)or g:BuffRemains(I.ShadowDance)>=4 and not g:BuffUp(I.ThistleTea)and R>=3 or not g:BuffUp(I.ThistleTea)and d.BossFilteredFightRemains("<=",6*I.ThistleTea:Charges())then if l.Cast(I.ThistleTea,nil,nil)then ae=381623;return"Thistle Tea"end end end;if w.Commons.Enabled.Potions and n()and v[1]and((g:BloodlustUp()or d.BossFilteredFightRemains("<",30)or g:BuffUp(I.SymbolsofDeath)and(g:BuffUp(I.ShadowBlades)or I.ShadowBlades:CooldownRemains()<=10))and not l.GUISettings.General.HoldPotforBL or l.GUISettings.General.HoldPotforBL and g:BloodlustUp())then local b5=G.PotionSelected()if b5 and b5:IsReady()then if l.Cast(b5,nil,nil)then ae=37;return"potion cooldowns 2"end end end;local b6=g:BuffUp(I.ShadowBlades)or not I.ShadowBlades:IsAvailable()and g:BuffUp(I.SymbolsofDeath)or d.BossFilteredFightRemains("<",20)if w.Commons.Enabled.Racials then if I.BloodFury:IsCastable()and b6 then if l.Cast(I.BloodFury,nil)then ae=20572;return"Cast Blood Fury"end end;if I.Berserking:IsCastable()and b6 then if l.Cast(I.Berserking,nil)then ae=26297;return"Cast Berserking"end end;if I.Fireblood:IsCastable()and b6 then if l.Cast(I.Fireblood,nil)then ae=265221;return"Cast Fireblood"end end;if I.AncestralCall:IsCastable()and b6 then if l.Cast(I.AncestralCall,nil)then ae=274738;return"Cast Ancestral Call"end end end;if w.Commons.Enabled.BottomTrinket or w.Commons.Enabled.TopTrinket then if J.AshesoftheEmbersoul:IsEquippedAndReady()then if g:BuffUp(I.Flagellation)and(I.InvigoratingShadowdust:IsAvailable()or g:BuffUp(I.ShadowDance))and not J.WitherbarksBranch:IsEquippedAndReady()then if l.Cast(J.AshesoftheEmbersoul,nil,nil)then if J.AshesoftheEmbersoul:ID()==ac then ae=24;return"AshesoftheEmbersoul top"elseif J.AshesoftheEmbersoul:ID()==ad then ae=30;return"AshesoftheEmbersoul bop"end end end end end;if w.Commons.Enabled.BottomTrinket or w.Commons.Enabled.TopTrinket then if J.WitherbarksBranch:IsEquippedAndReady()then if g:BuffUp(I.Flagellation)and(I.InvigoratingShadowdust:IsAvailable()or g:BuffUp(I.ShadowBlades)or J.BandolierOfTwistedBlades:IsEquippedAndReady())then if l.Cast(J.WitherbarksBranch,nil,nil)then if J.WitherbarksBranch:ID()==ac then ae=24;return"AshesoftheEmbersoul top"elseif J.WitherbarksBranch:ID()==ad then ae=30;return"AshesoftheEmbersoul bop"end end end end end;if w.Commons.Enabled.BottomTrinket or w.Commons.Enabled.TopTrinket then if J.Mirror:IsEquippedAndReady()then if g:BuffUp(I.ShadowDance)and(h:TimeToDie()>=15 or J.AshesoftheEmbersoul:IsEquipped())then if l.Cast(J.Mirror,nil,nil)then if J.Mirror:ID()==ac then ae=24;return"Mirror top"elseif J.Mirror:ID()==ad then ae=30;return"Mirror bop"end end end end end;local b7=g:GetUseableTrinkets(K)b7=g:GetUseableTrinkets(K)if b7 and(n()and not g:StealthUp(true,true)or d.BossFilteredFightRemains("<",10))then if b7 and((not J.Mirror:IsReady()or not J.Mirror:IsEquipped())and(J.WitherbarksBranch:IsEquipped()and not J.WitherbarksBranch:IsReady()and not J.AshesoftheEmbersoul:IsEquipped()or J.AshesoftheEmbersoul:IsEquipped()and not J.AshesoftheEmbersoul:IsReady()and not J.WitherbarksBranch:IsEquipped())or d.BossFilteredFightRemains("<",10))then if l.Cast(b7,nil,nil)then if b7:ID()==GetInventoryItemID("player",13)and w.Commons.Enabled.TopTrinket then ae=24;return"Generic use_items for "..b7:Name()elseif b7:ID()==GetInventoryItemID("player",14)and w.Commons.Enabled.BottomTrinket then ae=25;return"Generic use_items for "..b7:Name()end end end end;if I.ThistleTea:IsReady()then if(I.SymbolsofDeath:CooldownRemains()>=3 or g:BuffUp(I.SymbolsofDeath))and not g:BuffUp(I.ThistleTea)and(g:EnergyDeficitPredicted()>=100 and(g:ComboPointsDeficit()>=2 or R>=3)or I.ThistleTea:ChargesFractional()>=2.75 and g:BuffUp(I.ShadowDanceBuff))or g:BuffRemains(I.ShadowDanceBuff)>=4 and not g:BuffUp(I.ThistleTea)and R>=3 or not g:BuffUp(I.ThistleTea)and d.BossFilteredFightRemains("<=",6*I.ThistleTea:Charges())then if l.Cast(I.ThistleTea,nil,nil)then ae=381623;return"Thistle Tea"end end end;return false end;local function b8(a5)if l.CDsON()and not(G.IsSoloMode()and g:IsTanking(h))then if I.Vanish:IsCastable()then if(a0>1 or g:BuffUp(I.ShadowBlades)and I.InvigoratingShadowdust:IsAvailable())and not az()and(I.Flagellation:CooldownRemains()>=60 or not I.Flagellation:IsAvailable()or d.BossFilteredFightRemains("<=",30*I.Vanish:Charges()))and(I.SymbolsofDeath:CooldownRemains()>3 or not g:HasTier(30,2))and(I.SecretTechnique:CooldownRemains()>=10 or not I.SecretTechnique:IsAvailable()or I.Vanish:Charges()>=2 and I.InvigoratingShadowdust:IsAvailable()and(g:BuffUp(I.TheRotten)or not I.TheRotten:IsAvailable()))then T=b1(I.Vanish,a5)if T then return"Vanish Macro "..T end end end;if w.Commons.ShowPooling and g:Energy()<40 and I.Shadowmeld:IsCastable()then if l.CastPooling(I.Shadowmeld,g:EnergyTimeToX(40))then ae=1000;return"Pool for Shadowmeld"end end;if I.Shadowmeld:IsCastable()and N and not g:IsMoving()and g:EnergyPredicted()>=40 and g:EnergyDeficitPredicted()>=10 and not az()and a0>4 then T=b1(I.Shadowmeld,a5)if T then return"Shadowmeld Macro "..T end end end;if N and I.ShadowDance:IsCastable()then if(h:DebuffUp(I.Rupture)or I.InvigoratingShadowdust:IsAvailable())and aF()and(not I.TheFirstDance:IsAvailable()or a0>=4 or g:BuffUp(I.ShadowBlades))and(aA()and az()or(g:BuffUp(I.ShadowBlades)or g:BuffUp(I.SymbolsofDeath)and not I.Sepsis:IsAvailable()or g:BuffRemains(I.SymbolsofDeath)>=4 and not g:HasTier(30,2)or not g:BuffUp(I.SymbolsofDeath)and g:HasTier(30,2))and I.SecretTechnique:CooldownRemains()<10+12*aw(not I.InvigoratingShadowdust:IsAvailable()or g:HasTier(30,2)))then T=b1(I.ShadowDance,a5)if T then return"ShadowDance Macro 1 "..T end end end;return false end;local function b9(a5)local ba=not a5 or g:EnergyPredicted()>=a5;if l.AoEON()and I.ShurikenStorm:IsCastable()and R>=2+k(I.Gloomblade:IsAvailable()and g:BuffRemains(I.LingeringShadowBuff)>=6 or g:BuffUp(I.PerforatedVeinsBuff))then if ba and l.Cast(I.ShurikenStorm)then ae=197835;return"Cast Shuriken Storm"end;a3(I.ShurikenStorm,a5)end;if N then if I.Gloomblade:IsCastable()then if ba and l.Cast(I.Gloomblade)then ae=200758;return"Cast Gloomblade"end;a3(I.Gloomblade,a5)elseif I.Backstab:IsCastable()then if ba and l.Cast(I.Backstab)then ae=53;return"Cast Backstab"end;a3(I.Backstab,a5)end end;return false end;local function bb()U=nil;W=nil;V=0;L=I.AcrobaticStrikes:IsAvailable()and 8 or 5;M=I.AcrobaticStrikes:IsAvailable()and 13 or 10;N=h:IsInMeleeRange(L)O=h:IsInMeleeRange(M)t=HeroRotationCharDB.Toggles[5]s=HeroRotationCharDB.Toggles[4]u=HeroRotationCharDB.Toggles[12]v[1]=not HeroRotationCharDB.Toggles[15]v[2]=HeroRotationCharDB.Toggles[20]v[3]=HeroRotationCharDB.Toggles[21]v[4]=HeroRotationCharDB.Toggles[22]v[5]=HeroRotationCharDB.Toggles[23]v[6]=HeroRotationCharDB.Toggles[24]v[7]=HeroRotationCharDB.Toggles[25]v[8]=HeroRotationCharDB.Toggles[26]v[9]=HeroRotationCharDB.Toggles[27]v[10]=HeroRotationCharDB.Toggles[28]v[11]=HeroRotationCharDB.Toggles[29]v[12]=HeroRotationCharDB.Toggles[30]v[13]=HeroRotationCharDB.Toggles[54]v[13]=HeroRotationCharDB.Toggles[172]v[13]=HeroRotationCharDB.Toggles[173]SBReady=false;SDReady=false;VanishReady=false;SoDReady=false;STReady=false;if w.Subtlety.IncludedCooldowns.ShadowBlades and n()or w.Subtlety.IncludedSmallCooldowns.ShadowBlades and(n()or s)or not w.Subtlety.IncludedSmallCooldowns.ShadowBlades and not w.Subtlety.IncludedCooldowns.ShadowBlades then SBReady=true end;if w.Subtlety.IncludedCooldowns.ShadowDance and n()or w.Subtlety.IncludedSmallCooldowns.ShadowDance and(n()or s)or not w.Subtlety.IncludedSmallCooldowns.ShadowDance and not w.Subtlety.IncludedCooldowns.ShadowDance then SDReady=true end;if w.Subtlety.IncludedCooldowns.Vanish and n()or w.Subtlety.IncludedSmallCooldowns.Vanish and(n()or s)or not w.Subtlety.IncludedSmallCooldowns.Vanish and not w.Subtlety.IncludedCooldowns.Vanish then VanishReady=true end;if w.Subtlety.IncludedCooldowns.SymbolsofDeath and n()or w.Subtlety.IncludedSmallCooldowns.SymbolsofDeath and(n()or s)or not w.Subtlety.IncludedSmallCooldowns.SymbolsofDeath and not w.Subtlety.IncludedCooldowns.SymbolsofDeath then SoDReady=true end;if w.Subtlety.IncludedCooldowns.ShurikenTornado and n()or w.Subtlety.IncludedSmallCooldowns.ShurikenTornado and(n()or s)or not w.Subtlety.IncludedSmallCooldowns.ShurikenTornado and not w.Subtlety.IncludedCooldowns.ShurikenTornado then STReady=true end;ac=GetInventoryItemID("player",13)ad=GetInventoryItemID("player",14)al=false end;local function bc(U)if U[1]==I.Backstab and U[2]==I.Stealth then ae=600 elseif U[1]==I.Gloomblade and U[2]==I.Stealth then ae=700 end end;local function bd(U)if U:Name()==I.BlackPowder:Name()then ae=271111 elseif U:Name()==I.Eviscerate:Name()then ae=272222 elseif U:Name()==I.Rupture:Name()then ae=273333 elseif U:Name()==I.SliceandDice:Name()then ae=274444 end end;local function be()T=bb()U=nil;W=nil;V=0;L=I.AcrobaticStrikes:IsAvailable()and 8 or 5;M=I.AcrobaticStrikes:IsAvailable()and 13 or 10;N=h:IsInMeleeRange(L)O=h:IsInMeleeRange(M)if m()then P=g:GetEnemiesInRange(30)Q=g:GetEnemiesInMeleeRange(M)R=#Q;S=g:GetEnemiesInMeleeRange(L)else P={}Q={}R=1;S={}end;_=g:ComboPoints()Z=H.EffectiveComboPoints(_)a0=g:ComboPointsDeficit()a2=a8()a1=g:EnergyMax()-ay()if g:BuffUp(I.ShurikenTornado,nil,true)and _<H.CPMaxSpend()then local bf=H.TimeToNextTornado()if bf<=g:GCDRemains()or F(g:GCDRemains()-bf)<0.25 then local bg=R+aw(g:BuffUp(I.ShadowBlades))_=D(_+bg,H.CPMaxSpend())a0=E(a0-bg,0)if Z<H.CPMaxSpend()then Z=_ end end end;X=(4+Z*4)*0.3;Y=I.Eviscerate:Damage()*w.Subtlety.EviscerateDMGOffset;if T then return T end;if af>0 then af=0 end;if ae>0 then ae=0 end;ae=H.ReturnSpell()af=H.ReturnSpellMO()if l.GUISettings.General.OpenerReset>0 and not HeroRotationCharDB.Toggles[5]then y=GetTime()z=y+l.GUISettings.General.OpenerReset elseif l.GUISettings.General.OpenerReset>0 and z~=nil and GetTime()>z and HeroRotationCharDB.Toggles[5]then HeroRotationCharDB.Toggles[5]=not HeroRotationCharDB.Toggles[5]l.ToggleIconFrame:UpdateButtonText(5)l.Print("Opener is now "..(HeroRotationCharDB.Toggles[5]and"|cff00ff00enabled|r."or"|cffff0000disabled|r."))end;if l.QueuedCast()then ae=l.QueuedCast()return"Custom Queue "..i(ae):ID()end;if v[4]and I.CheapShot:IsUsableP()and I.CheapShot:CooldownRemains()<=0 and g:StealthUp(true,true)and not g:PrevGCD(1,I.CheapShot)then if l.Cast(I.CheapShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(I.CheapShot)then af=11833;return"queue Cheap Shot MO"else ae=1833;return"queue Cheap Shot"end end elseif(not I.CheapShot:IsUsableP()or I.CheapShot:CooldownRemains()>0 or g:PrevGCD(1,I.CheapShot))and v[4]then HeroRotationCharDB.Toggles[22]=not HeroRotationCharDB.Toggles[22]l.Print("Cheap Shot Queue is now "..(HeroRotationCharDB.Toggles[22]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if v[5]and I.KidneyShot:IsUsableP()and I.KidneyShot:CooldownRemains()<=0 then if l.Cast(I.KidneyShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(I.KidneyShot)then af=1408;return"queue Kidney Shot MO"else ae=408;return"queue Kidney Shot"end end elseif g:PrevGCD(1,I.KidneyShot)and v[5]then HeroRotationCharDB.Toggles[23]=not HeroRotationCharDB.Toggles[23]l.Print("Kidney Shot Queue is now "..(HeroRotationCharDB.Toggles[23]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if v[6]and I.Blind:IsUsableP()and I.Blind:CooldownRemains()<=0 then if l.Cast(I.Blind,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(I.Blind)then af=12094;return"queue Blind MO"else ae=2094;return"queue Blind"end end elseif(not I.Blind:IsUsableP()or I.Blind:CooldownRemains()>0)and v[6]then HeroRotationCharDB.Toggles[24]=not HeroRotationCharDB.Toggles[24]l.Print("Blind Queue is now "..(HeroRotationCharDB.Toggles[24]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if v[7]and I.Sap:IsUsableP()and I.Sap:CooldownRemains()<=0 then if l.Cast(I.Sap,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(I.Sap)then af=16770;return"queue Sap MO"else ae=6770;return"queue Sap"end end elseif(not I.Sap:IsUsableP()or I.Sap:CooldownRemains()>0)and v[7]then HeroRotationCharDB.Toggles[25]=not HeroRotationCharDB.Toggles[25]l.Print("Sap Queue is now "..(HeroRotationCharDB.Toggles[25]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if v[8]and I.ShurikenTornado:IsUsableP()and I.ShurikenTornado:CooldownRemains()<=0 then if l.Cast(I.ShurikenTornado,nil,nil,nil)then ae=277925;return"queue Shuriken Tornado"end elseif(not I.ShurikenTornado:IsUsableP()or I.ShurikenTornado:CooldownRemains()>0)and v[8]then HeroRotationCharDB.Toggles[26]=not HeroRotationCharDB.Toggles[26]l.Print("Shuriken Tornado Queue is now "..(HeroRotationCharDB.Toggles[26]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if v[9]and I.Feint:IsUsableP()and I.Feint:CooldownRemains()<=0 and g:AffectingCombat()then if l.Cast(I.Feint,nil,nil,nil)then ae=202;return"queue Shuriken Tornado"end elseif(not I.Feint:IsUsableP()or I.Feint:CooldownRemains()>0 or not g:AffectingCombat())and v[9]then HeroRotationCharDB.Toggles[27]=not HeroRotationCharDB.Toggles[27]l.Print("Feint Queue is now "..(HeroRotationCharDB.Toggles[27]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if v[10]and I.Flagellation:IsUsableP()and I.Flagellation:CooldownRemains()<=0 and g:AffectingCombat()then if l.Cast(I.Flagellation,nil,nil,nil)then ae=323654;return"queue Flagellation Queue"end elseif(not I.Flagellation:IsUsableP()or I.Flagellation:CooldownRemains()>0 or not g:AffectingCombat())and v[10]then HeroRotationCharDB.Toggles[28]=not HeroRotationCharDB.Toggles[28]l.Print("Flagellation Queue is now "..(HeroRotationCharDB.Toggles[28]and"|cff00ff00on|r."or"|cffff0000off|r."))end;T=H.CrimsonVial()if T then return T end;if g:AffectingCombat()and not g:IsDeadOrGhost()then T=H.Feint()if T then return T end;T=H.Evasion()if T then return T end;if g:HealthPercentage()<w.Commons.PhialHP and J.PhialofSerenity:IsReady()and J.PhialofSerenity:CooldownRemains()<=0 then if l.Cast(J.PhialofSerenity,nil)then ae=55;return"PhialofSerenity HP"end end;if g:HealthPercentage()<w.Commons.HealthstoneHP and J.Healthstone:IsReady()and J.Healthstone:CooldownRemains()<=0 then if l.Cast(J.Healthstone,nil)then ae=40;return"Healthstone HP"end end;if g:HealthPercentage()<w.Commons.HealPotHP and J.CosmicHealPot:IsReady()and J.CosmicHealPot:CooldownRemains()<=0 then if l.Cast(J.CosmicHealPot,nil)then ae=45;return"CosmicHealPot HP"end end;if g:HealthPercentage()<w.Commons.HealPotHP and J.HealPot:IsReady()and not J.CosmicHealPot:IsReady()and J.HealPot:CooldownRemains()<=0 then if l.Cast(J.HealPot,nil)then ae=41;return"HealPot HP"end end end;x={324736,228318,178658,333227,334800,334967,324737,326450,334470,320703,320012,324085,333241,331510,344739,368477,368396,355057,356133,342139,353706,355782,327155,359668,321220,158337,382555}if UnitExists("target")and I.Shiv:IsReady()and not v[13]then if UnitCanAttack("player","target")and UnitAffectingCombat("target")and UnitIsDead("target")~=true then for bh=0,40 do local au,au,bi,type,au,au,au,au,au,bj=UnitBuff("target",bh)for au,bk in pairs(x)do if bk==bj then if l.Cast(I.Shiv,nil)then ae=5938;return"Shiv Enrage"end end end end end end;local bl=g:AffectingCombat()and 180 or 900;local bm;if i(8679):IsAvailable()and w.Commons.LethalPoison=="Wound Poison"then bm=g:BuffRemains(i(8679))if bm<bl and not g:IsCasting(i(8679))then if l.Cast(i(8679))then ae=203;return"Wound Poison Refresh"end end elseif i(2823):IsAvailable()and w.Commons.LethalPoison=="Deadly Poison"then bm=g:BuffRemains(i(2823))if bm<bl and not g:IsCasting(i(2823))then if l.Cast(i(2823))then ae=208;return"Deadly Poison Refresh"end end elseif i(315584):IsAvailable()and w.Commons.LethalPoison=="Instant Poison"then bm=g:BuffRemains(i(315584))if bm<bl and not g:IsCasting(i(315584))then if l.Cast(i(315584))then ae=205;return"Instant Poison Refresh"end end end;if i(381637):IsAvailable()and w.Commons.NonLethalPoison=="Atrophic Poison"then bm=g:BuffRemains(i(381637))if bm<bl and not g:IsCasting(i(381637))then if l.Cast(i(381637))then ae=381637;return"Atropic Poison Refresh"end end elseif i(5761):IsAvailable()and w.Commons.NonLethalPoison=="Numbing Poison"then bm=g:BuffRemains(i(5761))if bm<bl and not g:IsCasting(NumbingPoison)then if l.Cast(i(5761))then ae=204;return"Numbing Poison Refresh"end end elseif i(3408):IsAvailable()and w.Commons.NonLethalPoison=="Crippling Poison"then bm=g:BuffRemains(i(3408))if bm<bl and not g:IsCasting(NumbingPoison)then if l.Cast(i(3408))then ae=206;return"Crippling Poison Refresh"end end end;if not g:AffectingCombat()and not g:IsDeadOrGhost()then if not g:BuffUp(I.ShadowDanceBuff)and not g:BuffUp(H.VanishBuffSpell())then T=H.Stealth(H.StealthSpell())if T then return T end end;if G.TargetIsValid()and(h:IsSpellInRange(I.Shadowstrike)or N)and(not g:AffectingCombat()or t)then if g:StealthUp(true,true)and(g:AffectingCombat()or t)then U=aU(true)if U then if type(U)=="table"and#U>1 then if r(nil,unpack(U))then bc(U)return"Stealthed Macro Cast or Pool (OOC): "..U[1]:Name()end else if p(U)then ae=U:ID()return"Stealthed Cast or Pool (OOC): "..U:Name()end end end elseif _>=5 and(g:AffectingCombat()or t)then T=aJ()if T then return T.." (OOC)"end elseif I.Backstab:IsCastable()and(g:AffectingCombat()or t)then if o(I.Backstab)then ae=53;return"Cast Backstab (OOC)"end end end;return end;if G.TargetIsValid()and(g:AffectingCombat()or t or g:BuffUp(I.VanishBuff)or g:BuffUp(I.VanishBuff)or g:BuffUp(I.VanishBuff2))then T=b4()if T then return"CDs: "..T end;if I.SliceandDice:IsCastable()and R<H.CPMaxSpend()and g:BuffRemains(I.SliceandDice)<g:GCD()and d.BossFilteredFightRemains(">",6)and _>=4 then if I.SliceandDice:IsReady()and o(I.SliceandDice)then ae=5171;return"Cast Slice and Dice (Low Duration)"end;a6(I.SliceandDice)end;if g:StealthUp(true,true)then U=aU(true)if U then if type(U)=="table"and#U>1 then if r(nil,unpack(U))then bc(U)return"Stealthed Macro "..U[1]:Name().."|"..U[2]:Name()end else if g:BuffUp(I.ShurikenTornado)and _~=g:ComboPoints()and(U==I.BlackPowder or U==I.Eviscerate or U==I.Rupture or U==I.SliceandDice)then if r(nil,I.ShurikenTornado,U)then bd(U)return"Stealthed Tornado Cast  "..U:Name()end else if p(U)then ae=U:ID()return"Stealthed Cast "..U:Name()end end end else if o(I.PoolEnergy)then ae=99999;return"Stealthed Pooling"end end end;local bn;if not I.Vigor:IsAvailable()or I.Shadowcraft:IsAvailable()then bn=g:EnergyDeficitPredicted()<=ay()else bn=g:EnergyPredicted()>=ay()end;if bn or I.InvigoratingShadowdust:IsAvailable()then T=b8(a1)if T then return"Stealth CDs: "..T end end;if Z>=H.CPMaxSpend()then T=aJ()if T then return"Finish: "..T end end;if a0<=1 or d.BossFilteredFightRemains("<=",1)and Z>=3 then T=aJ()if T then return"Finish: "..T end end;if R>=4 and Z>=4 then T=aJ()if T then return"Finish: "..T end end;if W then a3(W)end;T=b9(a1)if T then return"Build: "..T end;if l.CDsON()then if I.ArcaneTorrent:IsReady()and N and g:EnergyDeficitPredicted()>=15+g:EnergyRegen()then if l.Cast(I.ArcaneTorrent,nil)then ae=155145;return"Cast Arcane Torrent"end end;if I.ArcanePulse:IsReady()and N then if l.Cast(I.ArcanePulse,nil)then ae=260364;return"Cast Arcane Pulse"end end;if I.LightsJudgment:IsReady()then if l.Cast(I.LightsJudgment,nil)then ae=255647;return"Cast Lights Judgment"end end;if I.BagofTricks:IsReady()then if l.Cast(I.BagofTricks,nil)then ae=312411;return"Cast Bag of Tricks"end end end;if U and N then if type(U)=="table"and#U>1 then if r(g:EnergyTimeToX(V),unpack(U))then ae=U[1]:ID()return"Macro pool towards "..U[1]:Name().." at "..V end elseif U:IsCastable()then V=E(V,U:Cost())if p(U,g:EnergyTimeToX(V))then ae=U:ID()return"Pool towards: "..U:Name().." at "..V end end end;if I.ShurikenToss:IsCastable()and h:IsInRange(30)and not O and not g:StealthUp(true,true)and not g:BuffUp(I.Sprint)and g:EnergyDeficitPredicted()<20 and(a0>=1 or g:EnergyTimeToMax()<=1.2)then if p(I.ShurikenToss)then return"Cast Shuriken Toss"end end end end;local function bo()if HeroRotationCharDB.Toggles[5]then HeroRotationCharDB.Toggles[5]=not HeroRotationCharDB.Toggles[5]l.ToggleIconFrame:UpdateButtonText(5)end;if HeroRotationCharDB.Toggles[171]then HeroRotationCharDB.Toggles[171]=not HeroRotationCharDB.Toggles[171]end;if HeroRotationCharDB.Toggles[172]then HeroRotationCharDB.Toggles[172]=not HeroRotationCharDB.Toggles[172]end;if HeroRotationCharDB.Toggles[29]then HeroRotationCharDB.Toggles[29]=not HeroRotationCharDB.Toggles[29]end end;function ReturnSpell()if ae==0 then return 0 else return ae end end;function ReturnSpellMO()if af==0 then return 0 else return af end end;l.SetAPL(261,be,bo)